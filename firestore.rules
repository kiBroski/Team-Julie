
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSupervisor() {
      return isSignedIn() && getUserProfile().role == 'supervisor';
    }

    // NEW: Check if user is part of HQ team
    function isHQ() {
      return isSignedIn() && getUserProfile().team == 'HQ';
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Relaxed Read: Authenticated users can read profiles (Needed for dashboard lists)
      allow read: if isSignedIn();
      
      // Creation: Only allowed if user matches auth ID
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Update: Only owner or Supervisor of the same team, or HQ
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        (isSupervisor() && resource.data.team == getUserProfile().team) ||
        isHQ()
      );
    }

    // --- Installations Collection ---
    match /installations/{recordId} {
      // Read: Own records, Team records, or ALL records if HQ
      allow read: if isSignedIn() && (
        resource.data.createdByUid == request.auth.uid ||
        resource.data.Team == getUserProfile().team ||
        isHQ()
      );
      
      allow create: if isSignedIn();
      
      // Edit/Delete: Own, Team Supervisor, or HQ
      allow update, delete: if isSignedIn() && (
        resource.data.createdByUid == request.auth.uid ||
        resource.data.Team == getUserProfile().team ||
        isHQ()
      );
    }

    // --- Notes Collection ---
    match /notes/{noteId} {
      allow read, write: if isSignedIn() && (
        resource == null || resource.data.createdByUid == request.auth.uid
      );
    }

    // --- Announcements Collection ---
    match /announcements/{announceId} {
      // Relaxed Read: Authenticated users can read announcements
      allow read: if isSignedIn();
      
      allow write: if isSupervisor() && (
         request.resource.data.team == getUserProfile().team || 
         resource.data.team == getUserProfile().team ||
         isHQ()
      );
    }

    // --- Direct Messages Collection ---
    match /messages/{msgId} {
      // Sender or Recipient can read
      allow read: if isSignedIn() && (
        resource.data.recipientUid == request.auth.uid || 
        resource.data.senderUid == request.auth.uid
      );
      
      // Anyone can send a message
      allow create: if isSignedIn() && request.resource.data.senderUid == request.auth.uid;
      
      // Recipient can update (e.g. to mark as read)
      allow update: if isSignedIn() && resource.data.recipientUid == request.auth.uid;
    }
  }
}
